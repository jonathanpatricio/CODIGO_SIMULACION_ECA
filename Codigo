# Función que crea la población del ECA con dos y tres brazos de tratamiento
Pob_ECA <- function(n, t, b0, b1, b2, b3, b4, b5, var_v0i, var_v1i, cov_v0iv1i, var_eij) {
  # Semilla para fijar los números aleatorios
  set.seed(16)
  
  ## Librerías que utiliza la función
  library(MASS)
  library(dplyr)

  ## Parámetros del modelo
  
  # Tratamientos
  treat <- as.numeric(as.numeric(cbind(rep(0, n), rep(1, n)))) # Vector de unos y ceros Para dos brazos de tratamientos 
  
  treat_2 <- as.numeric(cbind(rep(0, n), rep(1, n), rep(0, n))) # Para tres brazos de tratamientos 
  treat_3 <- as.numeric(cbind(rep(0, n), rep(0, n), rep(1, n))) # Para tres brazos de tratamientos 
  
  
  # Tamaño total de la población
  n_2 <- n*2  # Para dos brazos de tratamiento
  n_3 <- n*3  # Para tres brazos de tratamiento
  
  # t_ij 
  t_j <- ((1:t)-1)/(t-1) # Estandarizando el vector que contiene los tiempos 
  tij  <- matrix(rep(t_j), nrow = n_2, ncol = t, byrow = TRUE)    # Para dos brazos de tratamiento 
  tij_ <- matrix(rep(t_j), nrow = n_3, ncol = t, byrow = TRUE)    # Para tres brazos de tratamiento
  
  # Errores eij
  mu_eij <- rep(0, t) # promedio de los errores # Vector de las medias de los errores
  cov_eij <- 0 # Covarianza de los errores
  sigma_eij <- matrix(rep(cov_eij, t*t), nrow = t, ncol = t); diag(sigma_eij) <- rep(var_eij, t) # Matriz de varianzas y covarianzas
  
  eij  <- mvrnorm(n_2, mu_eij, sigma_eij) # Errores de acuerdo con los parámetros establecidos. Para dos brazos de tratamiento
  eij_ <- mvrnorm(n_3, mu_eij, sigma_eij) # Errores de acuerdo con los parámetros establecidos. Para tres brazos de tratamiento
    
  # Efectos aleatorios
  mu_v0iv1i  <- rep(0, 2) # promedio de los efectos aleatorios
  sigma_v0iv1i  <- matrix(rep(cov_v0iv1i, 4), nrow = 2, ncol = 2); diag(sigma_v0iv1i) <- c(var_v0i, var_v1i) # Matriz de varianzas y covarianzas
  
  v_i  <- mvrnorm(n_2, mu_v0iv1i, sigma_v0iv1i) #efectos aleatorios de acuerdo con los parámetros establecidos
  v_i_ <- mvrnorm(n_3, mu_v0iv1i, sigma_v0iv1i) #efectos aleatorios de acuerdo con los parámetros establecidos
  
  # Efecto aleatorio del intercepto v_0i
  v0i  <- v_i[,1]   # Para dos brazos de tratamiento
  v0i_ <- v_i_[,1]  # Para tres brazos de tratamiento
  
  # Efecto aleatorio de la pendiente v_1i
  v1i <- v_i[,2]    # Para dos brazos de tratamiento
  v1i_ <- v_i_[,2]  # Para tres brazos de tratamiento
  
  # Beta_0
  b0_ <- b0 + v0i_  # Para tres brazos de tratamiento
  b0 <- b0 + v0i    # Para dos brazos de tratamiento
  
    # Beta_1
  b1_ <- b1 + v1i_  # Para tres brazos de tratamiento
  b1 <- b1 + v1i    # Para dos brazos de tratamiento
  
  # Beta_2
  b2_ <- b2 * treat_2  # Para tres brazos de tratamiento
  b2 <- b2 * treat     # Para dos brazos de tratamiento
  
  # Beta_3
  b3_ <- b3 * treat_2 # Para tres brazos de tratamiento
  b3 <- b3 * treat    # Para dos brazos de tratamiento
  
  # Beta_4
  b4_ <- b4 * treat_3  # Para tres brazos de tratamiento
  
  # Beta_5
  b5_ <- b5 * treat_3  # Para tres brazos de tratamiento
  
  # estimación y_ij a lo ancho
  yij_2_treat <- as.data.frame(b0  + b1 *tij  + b2  + b3 *tij  +                  v0i  + v1i *tij  + eij )  # Para dos brazos de tratamiento
  yij_3_treat <- as.data.frame(b0_ + b1_*tij_ + b2_ + b3_*tij_ + b4_ + b5_*tij_ + v0i_ + v1i_*tij_ + eij_)  # Para tres brazos de tratamiento
  
  # Añadiendo ID y el identificador de los brazos de tratamiento a los datos simulados con dos brazos tratamiento
  grupos <- as.numeric(as.numeric(cbind(rep(1, n), rep(2, n))))              # Creando un vector tipo factor para dos brazos de tratamiento
  yij_2_treat <- mutate(yij_2_treat, treat = as.factor(grupos), ID = 1:n_2)  # Agregando el ID y el brazo de tratamiento a los datos simulados a lo ancho
  
  # Añadiendo ID y el identificador de los brazos de tratamiento a los datos simulados con tres brazos de tratamiento
  grupos_ <- as.factor(cbind(rep(1, n), rep(2, n), rep(3, n)))    # Creando un vector tipo factor para dos brazos de tratamiento
  yij_3_treat <- mutate(yij_3_treat, treat = grupos_, ID = 1:n_3) # Agregando el ID y el brazo de tratamiento a los datos simulados a lo ancho
  
  # estimación y_ij a lo largo
  yij_2_treat_long <- reshape(data = yij_2_treat,varying = 1:t, v.names = "yij", timevar= "tiempo", idvar = "ID", direction = "long") # Para dos brazos de tratamiento
  yij_3_treat_long <- reshape(data = yij_3_treat,varying = 1:t, v.names = "yij", timevar= "tiempo", idvar = "ID", direction = "long") # Para tres brazos de tratamiento
  
  # Matriz de correlación 
  cor_2_treat <- cor(yij_2_treat[,1:t])  # Para dos brazos de tratamiento
  cor_3_treat <- cor(yij_3_treat[,1:t])  # Para tres brazos de tratamiento
  
  # Listado de resultados
  resul_2_treat <- list(yij_2 = yij_2_treat, yij_long_2 = yij_2_treat_long, v_i_2 = v_i,  eij_2 = eij, cor_2 = cor_2_treat)  # Para dos brazos de tratamiento
  resul_3_treat <- list(yij_3 = yij_3_treat, yij_long_3 = yij_3_treat_long, v_i_3 = v_i_, eij_3 = eij_, cor_3 = cor_3_treat) # Para tres brazos de tratamiento
  
  return(list(Treat_2 = resul_2_treat, Treat_3 = resul_3_treat ))
  
}

# Estableciento valores a la función creada para simular los datos del ECA con dos y tres brazos de tratamiento
estimaciones <- Pob_ECA(n = 5000, 
                        t = 8, 
                        b0 = 44.9, 
                        b1 = 0.11, 
                        b2 = -2.3, 
                        b3 = 0, 
                        b4 = -2.3, 
                        b5 = 0,
                        var_v0i = 10, 
                        var_v1i = 0.33, 
                        cov_v0iv1i = -0.6207212, 
                        var_eij = 8.7)
